generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
   provider = "postgresql"
   url      = env("DATABASE_URL")
}

enum CallStatus {
  pending
  responded
  recovered
  lost
}

enum MessageScenario {
  standard
  afterHours
  emergency
}

model MissedCall {
  id               String            @id @default(uuid())
  businessId       String
  callerName       String
  callerPhone      String
  timestamp        DateTime          @default(now())
  status           CallStatus        @default(pending)
  estimatedValue   Float?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  business         Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  autoResponses    AutoResponse[]
  customerResponse CustomerResponse?

  @@index([businessId])
  @@index([callerPhone])
  @@index([status])
}

model AutoResponse {
  id           String     @id @default(uuid())
  missedCallId String
  messageSent  String
  sentAt       DateTime   @default(now())
  templateUsed String
  missedCall   MissedCall @relation(fields: [missedCallId], references: [id], onDelete: Cascade)

  @@index([missedCallId])
}

model CustomerResponse {
  id           String     @id @default(uuid())
  missedCallId String     @unique
  responseText String
  receivedAt   DateTime   @default(now())
  wasRecovered Boolean    @default(false)
  missedCall   MissedCall @relation(fields: [missedCallId], references: [id], onDelete: Cascade)
}

model MessageTemplate {
  id          String          @id @default(uuid())
  businessId  String
  name        String
  messageBody String
  scenario    MessageScenario
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  business    Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, name])
  @@index([businessId])
}

model Business {
  id               String            @id @default(uuid())
  name             String
  phone            String
  twilioNumber     String            @unique
  settings         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  missedCalls      MissedCall[]
  messageTemplates MessageTemplate[]
}